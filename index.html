<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Character Builder – MVP</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#131721; --ink:#e7ebf3; --muted:#9aa4b2; --accent:#6ea8fe; --ok:#6bffb3; --no:#ff7a7a;
      --radius:14px; --gap:12px;
    }
    * { box-sizing: border-box }
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b0d12,#0f1115);color:var(--ink);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
    a{color:#9ec5ff;text-decoration:none}
    .wrap{max-width:980px;margin:0 auto;padding:18px}

    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:10px 0 16px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.3px}
    .brand .logo{width:26px;height:26px;border-radius:6px;background:#1b2334;border:1px solid #2a3651}
    .top-actions{display:flex;gap:8px;flex-wrap:wrap}

    .card{background:linear-gradient(180deg,#131721,#0f131b);border:1px solid #232b3c;border-radius:16px;padding:16px}
    .muted{color:var(--muted)}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:var(--gap)}

    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid #2a3651;background:#141a28;color:var(--ink);cursor:pointer}
    .btn.primary{background:#1a2336;border-color:#2a3b5f}
    .btn.ghost{background:transparent;border-color:#2a3651}
    .btn.danger{background:#331a1a;border-color:#4a2424}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .cta-grid{display:grid;grid-template-columns:1fr;gap:10px}

    .panel{display:flex;flex-direction:column;gap:12px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    label{font-weight:600}
    input[type="text"], select, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #2a3651;background:#0f141f;color:var(--ink)}

    .big-choices{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:10px}
    .big-choices .tile{padding:16px;border-radius:14px;border:1px solid #28334b;background:#111827;display:flex;flex-direction:column;gap:8px}
    .tile h3{margin:0 0 6px 0}

    .inline-badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#1a2131;border:1px solid #2a3856;border-radius:999px;padding:6px 10px;color:var(--muted)}

    .spacer{height:10px}
    .legend{color:var(--muted);font-size:12px}
    .footer{margin:18px 0;color:var(--muted)}

    /* Simple views */
    .view{display:none}
    .view.active{display:block}

    /* Three buttons area */
    .main-actions{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px}

    /* Docs list */
    .doclist{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px}
    .docitem{padding:12px;border-radius:12px;border:1px solid #28334b;background:#111827}
    .doccontent{white-space:pre-wrap;background:#0e141e;border:1px solid #24314a;border-radius:12px;padding:12px;max-height:340px;overflow:auto}

    @media (max-width:520px){
      .wrap{padding:14px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand"><div class="logo"></div>Character Builder</div>
      <div class="top-actions">
        <button class="btn ghost" id="exportBtn" title="Export current character to JSON">Export</button>
        <button class="btn ghost" id="importBtn" title="Import character JSON">Import</button>
        <input type="file" id="fileInput" accept="application/json" style="display:none" />
      </div>
    </div>

    <!-- Views -->
    <!-- PAGE: Inventory (simple placeholder for now) -->
<div id="view-inventory" class="view">
  <div class="card">
    <h2 style="margin-top:0">Inventory</h2>
    <div id="invCurrencies" class="muted">Currencies will list here.</div>
    <div class="row" style="margin-top:10px">
      <button class="btn ghost" onclick="show('main')">Back</button>
    </div>
  </div>
</div>

<!-- PAGE: Spellbook (placeholder) -->
<div id="view-spellbook" class="view">
  <div class="card">
    <h2 style="margin-top:0">Spellbook</h2>
    <p class="muted">Known spells will appear here later.</p>
    <div class="row" style="margin-top:10px">
      <button class="btn ghost" onclick="show('main')">Back</button>
    </div>
  </div>
</div>

    <div id="view-home" class="view active">
      <div class="card">
        <h2 style="margin-top:0">Welcome</h2>
        <p class="muted">Create a new character or import one you saved earlier. No accounts required.</p>
        <div class="cta-grid">
          <button class="btn primary" id="newCharacterBtn">New Character</button>
          <button class="btn" id="homeImportBtn">Import Character (JSON)</button>
          <button class="btn" id="homeDocsBtn">Info Documents</button>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="grid">
        <div class="tile card">
          <h3>Project notes</h3>
          <p class="muted">Add <code>data/docs_manifest.json</code> to list docs in your <code>docs/</code> folder. Use this to store rules/notes as you go.</p>
        </div>
        <div class="tile card">
          <h3>Tips</h3>
          <ul class="muted">
            <li>Start small. You can change schemas later.</li>
            <li>IDs stay stable; names can change.</li>
            <li>Export often. Keep JSON in cloud storage if you swap devices.</li>
          </ul>
        </div>
      </div>
    </div>

    <div id="view-main" class="view">
      <div class="card">
        <div class="row">
          <h2 style="margin:0;flex:1" id="charTitle">Character</h2>
          <div class="inline-badges">
            <span class="badge">Name: <strong id="badgeName">—</strong></span>
            <span class="badge">Archetype: <strong id="badgeArch">—</strong></span>
          </div>
        </div>
        <div class="main-actions">
          <!-- PAGE: Main — SECTION: Nav Buttons -->
          <button class="btn" id="btnInventory">Inventory</button>
          <button class="btn" id="btnSpellbook">Spellbook</button>
          <button class="btn primary" id="btnCharacter">Passport</button>
          <button class="btn primary" id="btnTraining">Training</button>
          <button class="btn primary" id="btnCombat">Combat</button>
          <button class="btn" id="btnDocs">Rules / Docs</button>
          <button class="btn" id="btnBookmarks" title="Quick links to perk trees (later)">Bookmarks</button>
        </div>
        <div class="spacer"></div>
        <div id="summary" class="grid"></div>
        <p class="legend">This summary shows only the essentials: identity, lineage, attributes, skills with differing specializations, and top perk trees.</p>
      </div>
    </div>

    <div id="view-character" class="view">
      <div class="card panel">
        <h2 style="margin-top:0">Passport</h2>
        <div class="row">
          <div style="flex:1;min-width:220px">
            <label for="name">Name</label>
            <input id="name" type="text" placeholder="e.g., Kael Voss" />
          </div>
          <div style="flex:1;min-width:220px">
            <label for="archetype">Archetype</label>
            <input id="archetype" type="text" placeholder="e.g., Bladedancer" />
          </div>
        </div>
        <div>
          <label for="notes">Notes</label>
          <textarea id="notes" rows="4" placeholder="Backstory, quirks, etc."></textarea>
        </div>
        <div class="row">
          <button class="btn" id="saveCharacterBtn">Save Changes</button>
          <button class="btn ghost" id="backToMainFromChar">Back</button>
        </div>
      </div>
    </div>

    <div id="view-training" class="view">
      <div class="card">
        <h2 style="margin-top:0">Training</h2>
        <p class="muted">Placeholder. We'll wire this after the Home & Summary are set.</p>
        <div class="row">
          <button class="btn ghost" id="backToMainFromTraining">Back</button>
        </div>
      </div>
    </div>

    <div id="view-combat" class="view">
      <div class="card">
        <h2 style="margin-top:0">Combat</h2>
        <p class="muted">Placeholder. We'll design this after Training.</p>
        <div class="row">
          <button class="btn ghost" id="backToMainFromCombat">Back</button>
        </div>
      </div>
    </div>

    <div id="view-docs" class="view">
      <div class="card">
        <h2 style="margin-top:0">Rules / Docs</h2>
        <div id="docsStatus" class="muted" style="margin-bottom:8px"></div>
        <div class="doclist" id="docList"></div>
        <div id="docViewer" class="doccontent" style="display:none;margin-top:12px"></div>
        <div class="row" style="margin-top:10px"><button class="btn ghost" id="backToHomeFromDocs">Back</button></div>
      </div>
    </div>

    <div class="footer">v0.3 • Home + Summary + Docs • JSON Export/Import • Static data-driven</div>
  </div>

  <script>
    // ===== Data loading =====
    let DATA = { attributes:null, skills:null, lineages:null, trees:null, docs:null, currencies:null };
    async function loadJSON(path){ const r = await fetch(path); if(!r.ok) throw new Error(path+': '+r.status); return r.json(); }
    async function loadText(path){ const r = await fetch(path); if(!r.ok) throw new Error(path+': '+r.status); return r.text(); }
    async function loadData(){
      const promises = [
        // DATA: add currencies holder
        // DATA: include currencies in the loader Promise.all
// (ADD this as another line inside your Promise.all)
        loadJSON('data/currencies.json').then(v=>DATA.currencies=v).catch(()=>DATA.currencies=null);
        loadJSON('data/attributes.json').then(v=>DATA.attributes=v).catch(()=>DATA.attributes=null),
        loadJSON('data/skills.json').then(v=>DATA.skills=v).catch(()=>DATA.skills=null),
        loadJSON('data/lineages.json').then(v=>DATA.lineages=v).catch(()=>DATA.lineages=null),
        loadJSON('data/trees.json').then(v=>DATA.trees=v).catch(()=>DATA.trees=null),
        loadJSON('data/docs_manifest.json').then(v=>DATA.docs=v).catch(()=>DATA.docs=null)
      ];
      await Promise.all(promises);
    }

    // ===== Minimal state & routing =====
    const VERSION = 1;
    const defaultCharacter = () => (
      // MODEL: character save shape (add wallet)
return {
  version: VERSION,
  identity: { name: 'New Character', lineageId: 'human', backgroundIds: [], disadvantageIds: [] },
  archetype: '',
  notes: '',
  attributes: { st:10, iq:10, dx:10, ht:10, will:10, per:10 },
  skills: {},
  specializations: {},
  perks: [],
  trees: {},
  wallet: {},              // <-- NEW
  meta: { createdAt: new Date().toISOString(), notes:'' }
};

    let current = null; // active character in memory

    const views = {
      // ROUTING: register new views
      inventory: document.getElementById('view-inventory'),
      spellbook: document.getElementById('view-spellbook'),
      home: document.getElementById('view-home'),
      main: document.getElementById('view-main'),
      character: document.getElementById('view-character'),
      training: document.getElementById('view-training'),
      combat: document.getElementById('view-combat'),
      docs: document.getElementById('view-docs')
    };

    function show(id){
      Object.values(views).forEach(v=>v.classList.remove('active'));
      views[id].classList.add('active');
      if(id==='main'){ updateMainBadges(); renderSummary(); }
      if(id==='character') loadCharacterForm();
      if(id==='docs') loadDocs();
      if (id === 'inventory') renderInventory();
      if (id === 'spellbook') {/* later */}

    }

    // ---- Home actions ----
    document.getElementById('newCharacterBtn').onclick = () => {
      current = defaultCharacter();
      location.hash = '#/main';
      show('main');
    };
    document.getElementById('homeImportBtn').onclick = () => document.getElementById('fileInput').click();
    document.getElementById('homeDocsBtn').onclick = () => { location.hash = '#/docs'; show('docs'); };

    // ---- Main actions ----
    // PAGE: Main — SECTION: Nav Buttons (Inventory/Spellbook)
    document.getElementById('btnInventory').onclick = ()=> { show('inventory'); };
    document.getElementById('btnSpellbook').onclick = ()=> { show('spellbook'); };
    document.getElementById('btnCharacter').onclick = ()=>{ show('character'); };
    document.getElementById('btnTraining').onclick = ()=>{ show('training'); };
    document.getElementById('btnCombat').onclick = ()=>{ show('combat'); };
    document.getElementById('btnDocs').onclick = ()=>{ show('docs'); };

    // ---- Character form ----
    const nameInput = document.getElementById('name');
    const archInput = document.getElementById('archetype');
    const notesInput = document.getElementById('notes');
    function loadCharacterForm(){
      if(!current) return;
      nameInput.value = current.identity?.name || '';
      archInput.value = current.archetype || '';
      notesInput.value = current.notes || '';
    }
    document.getElementById('saveCharacterBtn').onclick = () => {
      if(!current) return;
      current.identity.name = nameInput.value.trim() || 'Unnamed';
      current.archetype = archInput.value.trim();
      current.notes = notesInput.value.trim();
      updateMainBadges();
      alert('Saved.');
    };
    document.getElementById('backToMainFromChar').onclick = ()=> show('main');

    // ---- Training / Combat back ----
    document.getElementById('backToMainFromTraining').onclick = ()=> show('main');
    document.getElementById('backToMainFromCombat').onclick = ()=> show('main');

    // ---- Docs view ----
    const docsStatus = document.getElementById('docsStatus');
    const docList = document.getElementById('docList');
    const docViewer = document.getElementById('docViewer');

    async function loadDocs(){
      docList.innerHTML = '';
      docViewer.style.display = 'none';
      docViewer.textContent = '';
      if(!DATA.docs){
        docsStatus.innerHTML = 'No manifest found. Create <code>data/docs_manifest.json</code> and a <code>docs/</code> folder.';
        return;
      }
      docsStatus.textContent = 'Select a document to open:';
      DATA.docs.docs.forEach(d => {
        const item = document.createElement('div');
        item.className = 'docitem';
        const h = document.createElement('div'); h.style.fontWeight='700'; h.textContent = d.title || d.id;
        const p = document.createElement('div'); p.className='muted'; p.textContent = d.path;
        const open = document.createElement('button'); open.className='btn'; open.textContent='Open';
        open.onclick = async () => {
          docViewer.style.display = 'block';
          docViewer.textContent = 'Loading…';
          try{ const text = await loadText(d.path); docViewer.textContent = text; }
          catch(err){ docViewer.textContent = 'Failed to load: ' + err.message; }
        };
        item.append(h,p,open);
        docList.appendChild(item);
      });
    }

    // ---- Badges ----
    function updateMainBadges(){
      document.getElementById('charTitle').textContent = current ? `Character – ${current.identity?.name||''}` : 'Character';
      document.getElementById('badgeName').textContent = current?.identity?.name || '—';
      document.getElementById('badgeArch').textContent = current?.archetype || '—';
    }

    // ---- Summary renderer (a–f) ----
    const summaryEl = document.getElementById('summary');
    function summaryTile(title, contentHTML){
      const div = document.createElement('div');
      div.className = 'tile card';
      const h = document.createElement('h3'); h.textContent = title; h.style.marginTop='0';
      const c = document.createElement('div'); c.innerHTML = contentHTML;
      div.append(h,c); return div;
    }

    function renderSummary(){
      summaryEl.innerHTML = '';
      if(!current) return;

      // a) Name + Backgrounds/Disadvantages
      const bgs = (current.identity?.backgroundIds||[]).join(', ') || '<span class="muted">None</span>';
      const dis = (current.identity?.disadvantageIds||[]).join(', ') || '<span class="muted">None</span>';
      summaryEl.appendChild(summaryTile('Identity', `
        <div><strong>Name:</strong> ${escapeHTML(current.identity?.name||'')}</div>
        <div><strong>Backgrounds:</strong> ${bgs}</div>
        <div><strong>Disadvantages:</strong> ${dis}</div>
      `));

      // b) Lineage
      let lineageName = current.identity?.lineageId || 'human';
      if(DATA.lineages){
        const found = DATA.lineages.lineages.find(x=>x.id===lineageName);
        if(found) lineageName = found.name;
      }
      summaryEl.appendChild(summaryTile('Lineage', `<div>${escapeHTML(lineageName)}</div>`));

      // PAGE: Main — SECTION: Lineage Traits (ADD THIS AFTER THE LINEAGE TILE)
if (DATA.lineages) {
  const lid = current.identity?.lineageId || 'human';
  const lin = DATA.lineages.lineages.find(x => x.id === lid);
  if (lin && Array.isArray(lin.traits) && lin.traits.length) {
    const list = '<ul>' + lin.traits.map(t => `<li>${escapeHTML(t)}</li>`).join('') + '</ul>';
    summaryEl.appendChild(summaryTile('Lineage Traits', list));
  }
}

      
      // c) Attributes
      const attrs = current.attributes || {};
      let attrsHTML = '<ul class="muted">';
      const order = DATA.attributes?.attributes?.map(a=>a.id) || Object.keys(attrs);
      order.forEach(id=>{
        if(id in attrs) attrsHTML += `<li><strong>${escapeHTML(id.toUpperCase())}</strong>: ${attrs[id]}</li>`;
      });
      attrsHTML += '</ul>';
      summaryEl.appendChild(summaryTile('Attributes', attrsHTML));

      // d) Core skills + differing specializations
// PAGE: Main — SECTION: Skills Summary (always show core; specs only if different)
(function renderSkills() {
  const allSkills = DATA.skills?.skills || [];
  const attrs = current.attributes || {};
  const skillPts = current.skills || {};
  const specPts = current.specializations || {};

  // helper: evaluate default "dx - 3" against attrs
  function evalDefault(formula) {
    if (!formula) return 0;
    const m = /([a-z]+)\s*([+-])\s*(\d+)/i.exec(formula);
    if (!m) return 0;
    const base = attrs[m[1].toLowerCase()] ?? 0;
    const sign = m[2] === '-' ? -1 : 1;
    const n = parseInt(m[3], 10) || 0;
    return base + sign * n;
  }

  let html = '<ul>';
  allSkills.forEach(s => {
    const coreDefault = s.default ? evalDefault(s.default.formula) : 0;
    const coreLevel = (Number(skillPts[s.id] || 0)) + coreDefault;

    html += `<li><strong>${escapeHTML(s.name)}</strong>: ${coreLevel}`;

    // specs that differ: either spec points ≠ 0 OR an explicit defaultFromCoreDelta pushes it
    const diffs = [];
    (s.specializations || []).forEach(sp => {
      const key = `${s.id}:${sp.id}`;
      const delta = Number(specPts[key] || 0);
      const bump = Number(sp.defaultFromCoreDelta || 0);
      const specLevel = coreLevel + bump + delta;
      if (bump !== 0 || delta !== 0) {
        diffs.push(`${sp.name}: ${specLevel}`);
      }
    });

    if (diffs.length > 0) {
      html += `<div class="muted">• ${diffs.join(' • ')}</div>`;
    }
    html += '</li>';
  });
  html += '</ul>';

  summaryEl.appendChild(summaryTile('Skills (core always; specs only if different)', html));
})();

// PAGE: Inventory — SECTION: Render
function renderInventory() {
  const wrap = document.getElementById('invCurrencies');
  if (!wrap) return;
  if (!DATA.currencies) { wrap.textContent = 'Define data/currencies.json to track money/resources.'; return; }

  const wallet = current?.wallet || {};
  const fiat = DATA.currencies.fiat || [];
  const res  = DATA.currencies.resources || [];
  let html = '<h3>Wallet</h3>';

  if (fiat.length) {
    html += '<div><strong>Fiat</strong></div><ul>';
    fiat.forEach(c => { html += `<li>${escapeHTML(c.name)}: ${wallet[c.id] || 0}</li>`; });
    html += '</ul>';
  }
  if (res.length) {
    html += '<div><strong>Resources</strong></div><ul>';
    res.forEach(c => { html += `<li>${escapeHTML(c.name)}: ${wallet[c.id] || 0}</li>`; });
    html += '</ul>';
  }
  wrap.innerHTML = html;
}

      
      // e) Top 5 trees by pointsSpent
      const trees = current.trees || {};
      const entries = Object.entries(trees).sort((a,b)=>b[1]-a[1]).slice(0,5);
      if(entries.length===0){
        summaryEl.appendChild(summaryTile('Top Perk Trees', '<span class="muted">No investments yet.</span>'));
      } else {
        let html = '<ol>';
        entries.forEach(([id,pts])=>{
          let name = id;
          const t = DATA.trees?.trees?.find(x=>x.id===id);
          if(t) name = t.name;
          html += `<li><strong>${escapeHTML(name)}</strong>: ${pts} pts</li>`;
        });
        html += '</ol>';
        summaryEl.appendChild(summaryTile('Top Perk Trees', html));
      }

// PAGE: Main — SECTION: Currencies Summary
(function renderCurrencies() {
  if (!DATA.currencies) return;
  const wallet = current.wallet || {};
  const fiat = DATA.currencies.fiat || [];
  const res  = DATA.currencies.resources || [];

  let html = '';
  if (fiat.length) {
    html += '<div><strong>Fiat</strong></div><ul>';
    fiat.forEach(c => { html += `<li>${escapeHTML(c.name)}: ${wallet[c.id] || 0}</li>`; });
    html += '</ul>';
  }
  if (res.length) {
    html += '<div><strong>Resources</strong></div><ul>';
    res.forEach(c => { html += `<li>${escapeHTML(c.name)}: ${wallet[c.id] || 0}</li>`; });
    html += '</ul>';
  }
  summaryEl.appendChild(summaryTile('Currencies', html || '<span class="muted">None tracked yet.</span>'));
})(  );

      
      // f) Rules/Docs link hint
      summaryEl.appendChild(summaryTile('Rules / Docs', `
        <div>Open the Rules / Docs library for searchable references.</div>
        <div style="margin-top:8px"><button class="btn" onclick="show('docs')">Open Docs</button></div>
      `));
    }

    function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

    // ---- Export / Import ----
    document.getElementById('exportBtn').onclick = () => {
      if(!current){ alert('No character loaded.'); return; }
      const data = { ...current, version: VERSION, exportedAt: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${(current.identity?.name||'character').replace(/[^a-z0-9-_]+/gi,'_')}-${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    };

    const fileInput = document.getElementById('fileInput');
    document.getElementById('importBtn').onclick = () => fileInput.click();
    document.getElementById('homeImportBtn').onclick = () => fileInput.click();
    fileInput.onchange = (e) => {
      const f = e.target.files?.[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const obj = JSON.parse(reader.result);
          if(obj && typeof obj==='object' && obj.version===VERSION){
            current = obj; location.hash = '#/main'; show('main');
          } else { alert('Import failed: wrong or missing version.'); }
        }catch(err){ alert('Import failed: invalid JSON.'); }
        fileInput.value = '';
      };
      reader.readAsText(f);
    };

    // ---- Hash routing ----
    function route(){
      const hash = location.hash || '#/';
      if (hash.startsWith('#/inventory')) return show('inventory');
      if (hash.startsWith('#/spellbook')) return show('spellbook');
      if(hash.startsWith('#/docs')) return show('docs');
      if(hash.startsWith('#/main')) return show('main');
      if(hash.startsWith('#/character')) return show('character');
      if(hash.startsWith('#/training')) return show('training');
      if(hash.startsWith('#/combat')) return show('combat');
      return show('home');
    }
    window.addEventListener('hashchange', route);

    // Init: load data then route
    loadData().then(route).catch(()=>route());
  </script>
</body>
</html>
